# Session 2026-02-21 -- Fix Reorganize Pipeline

**Session ID:** f681e9e3-032e-4521-aa4e-ee15eeb2ea33
**Date:** 2026-02-21
**Branch:** feat/python-rewrite

## Summary

Fixed the audiobook pipeline's organize/reorganize functionality. Addressed 4 known issues (directory context loss, ffprobe failures, AI evidence gaps, cache staleness) and validated against 9 acceptance criteria. All tests passed. Created validation report and committed all changes.

## What Was Done

1. Fixed parse_path() directory context loss -- constructed synthetic path `source_path / source_file.name` so parse_path() always sees the book directory name as parent, preserving rich metadata from directory names like "James Islington - The Licanius Trilogy"
2. Added graceful ffprobe failure handling -- wrapped get_tags() and extract_author_from_tags() in try/except, falling back to empty tags dict and empty author string for empty/corrupt audio files
3. Added source_directory parameter to AI resolve() -- included directory path in LLM evidence so the AI can see book directory names for better metadata resolution
4. Fixed LiteLLM semantic cache returning stale responses -- added `extra_body={"cache": {"no-cache": True}}` to both resolve() and disambiguate() API calls (the existing Cache-Control header was being ignored by the proxy)
5. Added debug logging of raw AI responses in ai.py
6. Fixed cleanup.py type error -- changed `manifest.update_stage()` (doesn't exist) to `manifest.set_stage()` with proper Stage and StageStatus enums
7. Fixed type-check hook (pre-bash-type-check.ts) -- changed camelCase field names (toolName/toolInput) to snake_case (tool_name/tool_input) matching Claude Code's actual hook input format, and switched to process.exit(2) + stderr blocking pattern
8. Removed intentional type error from __init__.py (was used for hook testing)
9. Created test sandbox with 5 real books (~1.3GB), ran dry-run (correct AI resolution), real run (all moved correctly), re-run (all "already correctly placed"), verified empty dir cleanup, then removed sandbox
10. Wrote validation report to .reports/reorganize-pipeline.md
11. Committed all changes as 8a43b5e on feat/python-rewrite

## Files Changed

- src/audiobook_pipeline/stages/organize.py -- parse_path fix, ffprobe error handling, source_directory context, reorganize mode refactor
- src/audiobook_pipeline/ai.py -- source_directory param, cache bypass, response logging
- src/audiobook_pipeline/runner.py -- batch processing refactor (file -> book directory iteration)
- src/audiobook_pipeline/stages/__init__.py -- removed intentional type error
- src/audiobook_pipeline/stages/cleanup.py -- fixed type error (update_stage -> set_stage with enums)
- ~/.claude/hooks/safety/pre-bash-type-check.ts -- fixed snake_case fields, exit code blocking
- .reports/reorganize-pipeline.md -- validation report

## Decisions Made

- parse_path() receives synthetic path `source_path / source_file.name` rather than raw directory path (preserves hierarchy for regex patterns)
- LiteLLM cache bypass uses `extra_body={"cache": {"no-cache": True}}` (LiteLLM-specific mechanism, not HTTP headers)
- Type-check hook uses process.exit(2) + stderr pattern (matching security-validator hook)
- Claude Code hook input uses snake_case: tool_name/tool_input (NOT camelCase)

## Known Issues / Blockers

None remaining. All 9 acceptance criteria met.

## Learnings

- **Claude Code hook input fields are snake_case** -- tool_name, tool_input (NOT camelCase: toolName/toolInput). Discovered by comparing with working security-validator hook.
- **LiteLLM semantic cache ignores Cache-Control headers** -- must use extra_body for cache bypass via `{"cache": {"no-cache": True}}`
- **parse_path() directory hierarchy breaks with raw directory paths** -- when you pass a directory path, basename becomes the dir name, breaking the parent/file pattern. Synthetic file paths preserve correct hierarchy.

## Next Session

### Carry-forward (from previous sessions)
- Merge feat/python-rewrite to main via PR
- Consider improvements for known issues (SRoST junk, subseries vs unified, filename cleanup)
- Add more test cases for edge patterns discovered during live testing

### New from this session
- Reorganize mode now fully functional and tested (9/9 acceptance criteria met)
- Type-check hook now working correctly (blocking on type errors)
- Cache bypass mechanism confirmed for LiteLLM semantic cache
