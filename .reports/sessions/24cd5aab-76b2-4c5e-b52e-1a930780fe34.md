# Session 2026-02-23 -- Pipeline Levels (24cd5aab)

**Branch:** feat/python-rewrite
**Type:** Feature -- intelligence tier system, agent documentation, project instructions

## Summary

Implemented a four-tier pipeline intelligence system (simple/normal/ai/full) controlled by PIPELINE_LEVEL env var and --level CLI flag. Also created docs/install.md agent guide, .claude/agents/audiobook-guide.md custom agent, and project CLAUDE.md for quick reference.

## What Was Done

1. **Added PipelineLevel enum and config integration:**
   - Created `PipelineLevel` StrEnum in models.py with four tiers: simple, normal, ai, full
   - Added `pipeline_level` field to config.py with `level` property accessor
   - Added TYPE_CHECKING import to config.py for mypy compatibility
   - Default level is "normal" (no AI, best-effort organize)

2. **Implemented --level CLI flag:**
   - Added `--level` flag to cli.py with completion/validation
   - Level resolution logic: CLI flag > env var > default (normal)
   - Implicit AI requirements: --reorganize/--ai-all force ai minimum with warning
   - Mutual exclusivity: ai/full levels set ai_all=True, simple/normal force ai_all=False

3. **Updated pipeline runner for level-aware execution:**
   - Simple level strips ORGANIZE/ARCHIVE stages (dry-run-style execution)
   - Added `_copy_output_to_source()` method to copy tagged m4b back to source directory
   - Simple level copies output to source after metadata stage completes

4. **Gated AI checks by pipeline level:**
   - Updated asin.py AI disambiguation checks to explicit membership: `in (PipelineLevel.AI, PipelineLevel.FULL)`
   - Simple/normal levels never call LLM even if PIPELINE_LLM_MODEL configured
   - Fixed StrEnum comparison bug: alphabetical ordering means >= doesn't work for level ordering

5. **Created agent-readable documentation:**
   - **docs/install.md** (~360 lines) -- Comprehensive setup guide covering prerequisites, config, LLM setup, workflows, troubleshooting, level reference
   - **.claude/agents/audiobook-guide.md** -- Custom Claude Code agent for "full" mode interactive guidance
   - **CLAUDE.md** -- Project-level quick reference for agents

6. **Updated documentation and tests:**
   - Updated README.md with Pipeline Levels section
   - Updated __init__.py docstrings to document PipelineLevel and --level flag
   - Added 11 new tests across test_models.py, test_config.py, test_cli.py
   - Fixed existing test_asin.py AI disambiguation test to set pipeline_level="ai"

7. **Verification:**
   - Dry-run at ai level (HP3 book) -- LLM disambiguated to J.K. Rowling
   - Dry-run at simple level -- No AI, no organize stages, copied tagged m4b to source

8. **Updated PR #5:**
   - New description with Pipeline Levels feature
   - Pushed 3 commits to remote (a1db8f9, 609427e, f864d7d)

## Files Changed

- `src/audiobook_pipeline/models.py` -- PipelineLevel StrEnum (simple/normal/ai/full)
- `src/audiobook_pipeline/config.py` -- pipeline_level field, level property, TYPE_CHECKING import
- `src/audiobook_pipeline/cli.py` -- --level flag, level resolution logic, AI implicit requirements
- `src/audiobook_pipeline/runner.py` -- simple level stage filtering, _copy_output_to_source()
- `src/audiobook_pipeline/stages/asin.py` -- AI gating by level (`in (AI, FULL)`)
- `src/audiobook_pipeline/__init__.py` -- docstring updates
- `.env` -- PIPELINE_LEVEL=ai (local config, gitignored)
- `README.md` -- Pipeline Levels section
- `tests/test_models.py` -- TestPipelineLevel (string conversion, iteration)
- `tests/test_config.py` -- TestPipelineLevel (default, env var, property access)
- `tests/test_cli.py` -- TestLevelFlag (parsing, resolution, AI requirements, mutual exclusivity)
- `tests/test_stages/test_asin.py` -- pipeline_level="ai" fix for AI disambiguation test
- `docs/install.md` -- NEW agent setup guide
- `.claude/agents/audiobook-guide.md` -- NEW custom agent
- `CLAUDE.md` -- NEW project instructions

## Decisions Made

- **StrEnum comparison is alphabetical, not ordinal** -- Use explicit membership checks `in (AI, FULL)` instead of `>=` for level ordering
- **Default level is "normal"** -- No AI, best-effort organize. Balances safety and utility.
- **"full" level behaves identically to "ai" in pipeline code** -- Difference is external (agent guide provides interactive help). No code branching on full vs ai.
- **.env is gitignored** -- PIPELINE_LEVEL config change is local-only (has credentials), won't be committed
- **ai/full levels implicitly set ai_all=True** -- Prevents confusion when user sets level=ai but forgets --ai-all
- **simple/normal force ai_all=False** -- Explicit validation error if user tries to combine --ai-all with simple/normal level

## Known Issues / Blockers

None.

## Learnings

- **StrEnum ordering pitfall** -- Python StrEnum orders alphabetically ("ai" < "full" < "normal" < "simple"), making `>=` comparisons unreliable for semantic level ordering. Use explicit membership checks or IntEnum for ordinal comparisons.
- **Level vs mode orthogonality** -- Pipeline level (intelligence tier) is orthogonal to mode (convert/reorganize). Level controls what intelligence features are available, mode controls what stages run.
- **Simple level semantics** -- "simple" means "tag and return to source, no reorganization". Equivalent to dry-run but actually writes the tagged m4b.
- **Agent documentation value** -- Having install.md and custom agent significantly improves agent onboarding for this project. Agents can self-serve setup questions.

## New Ideas

None.

## Commits

- a1db8f9 -- feat: add pipeline intelligence levels (simple/normal/ai/full)
- 609427e -- docs: add install guide, custom agent, project instructions
- f864d7d -- session: wrap 2026-02-23 -- TB library migration and chaptered m4b support (619a0225)

## Next Steps

- Merge PR #5 when ready
- SQLite migration (from previous session carry-forward)
- Brandon Sanderson NFS cleanup (duplicate Mistborn folders)
- Consider author hint parameter for chaptered books
