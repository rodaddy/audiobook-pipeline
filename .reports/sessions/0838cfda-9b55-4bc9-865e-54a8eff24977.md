# Session 2026-02-22 -- Pipeline Reordering and ASIN Stage (0838cfda)

**Branch:** feat/python-rewrite
**Type:** Feature -- ASIN resolution stage, metadata embedding rewrite

## Summary

Reordered pipeline to separate concerns: ASIN stage resolves metadata (Audible/AI/tags), metadata stage embeds tags + cover art, organize stage moves files. Files are now tagged before landing in the library. Cover art now embedded as attached_pic via ffmpeg (-map 0 -map 1 -disposition:v:0 attached_pic).

**New order:** validate -> concat -> convert -> asin -> metadata -> organize -> cleanup

## What Was Done

1. **Created `stages/asin.py` (~200 lines)** -- Extracted all Audible/AI/tag resolution logic from organize.py. Reads tags from convert output or source via `_find_tag_file()`. Searches Audible, disambiguates via AI when needed. Writes parsed_author, parsed_title, parsed_series, parsed_position, parsed_asin, cover_url to manifest.

2. **Modified `api/audible.py`** -- Changed `image_sizes` from "100" to "500,1024", added `cover_url` to search results (prefers 1024px, falls back to 500px).

3. **Rewrote `stages/metadata.py`** -- Now reads output file from convert stage (work_dir) instead of organize stage. Downloads cover art from cover_url via httpx. Embeds cover as attached_pic via ffmpeg. Cover download failure is non-fatal. Records output_file in manifest for organize to pick up.

4. **Slimmed `stages/organize.py` (~100 lines removed)** -- Pure file-mover now. Reads pre-resolved metadata from manifest (set by ASIN stage). `_find_source_file()` priority: metadata output > convert output > source discovery. Removed all AI/Audible/tag imports and logic. Uses is_file() instead of exists() to avoid treating directories as files.

5. **Updated wiring** -- models.py STAGE_ORDER (CONVERT mode: validate->concat->convert->asin->metadata->organize->archive->cleanup), stages/__init__.py (ASIN registered), convert_orchestrator.py (new stage order, ASIN runs in dry-run, removed organize source_path override).

6. **Created `tests/test_stages/test_asin.py`** -- 11 new tests covering search strategies, manifest writes, AI disambiguation, dry-run, convert output reading.

7. **Updated `tests/test_stages/test_metadata.py`** -- Changed to use convert output, added 4 cover art tests (embed, download failure, no URL, enrich mode).

8. **Updated `tests/test_stages/test_organize.py`** -- Simplified, removed all Audible/AI mocks, tests manifest reads and metadata stage output.

9. **Updated docstrings** -- stages/__init__.py and __init__.py for new pipeline order.

## Files Changed

- src/audiobook_pipeline/stages/asin.py (NEW)
- src/audiobook_pipeline/stages/metadata.py (REWRITTEN)
- src/audiobook_pipeline/stages/organize.py (MODIFIED - slimmed)
- src/audiobook_pipeline/api/audible.py (MODIFIED)
- src/audiobook_pipeline/stages/__init__.py (MODIFIED)
- src/audiobook_pipeline/models.py (MODIFIED)
- src/audiobook_pipeline/convert_orchestrator.py (MODIFIED)
- src/audiobook_pipeline/__init__.py (MODIFIED)
- tests/test_stages/test_asin.py (NEW)
- tests/test_stages/test_metadata.py (REWRITTEN)
- tests/test_stages/test_organize.py (REWRITTEN)

## Decisions Made

- Pipeline reordered: validate -> concat -> convert -> asin -> metadata -> organize -> cleanup (was: ...convert -> organize -> metadata -> cleanup)
- ASIN stage runs in dry-run mode (metadata-only, no file changes)
- Cover art download failure is non-fatal -- file gets tagged without cover
- Audible API now requests 500/1024px images (was 100px only)
- When Audible match is confident and no AI needed, series/position from Audible result are also applied (not just author)
- organize.py uses is_file() instead of exists() to prevent treating directories as valid output files
- metadata.py records output_file in manifest so organize can find the tagged file

## Known Issues / Blockers

- mypy stubs missing for loguru and psutil (pre-existing across whole project, not new)
- No end-to-end test with real MP3s yet (user will test manually)

## Learnings

- manifest.create() pre-completes CONVERT stage with output_file=source_path for non-convert modes. This means _find_source_file() and _find_output_file() must check is_file() not exists(), otherwise directories get treated as valid output files.

## Commits

- 609427e -- feat: reorder pipeline -- ASIN resolution before metadata and organize

## Next Steps

- E2E test with real audio files in convert mode
- Monitor batch conversion progress
- Fix any conversion issues that surface
- Consider filtering parent dirs (no audio) earlier
