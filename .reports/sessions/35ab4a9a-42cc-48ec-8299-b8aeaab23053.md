# Session: Organize Edge Cases and Dedup

**Date:** 2026-02-21
**Branch:** feat/python-rewrite
**Session ID:** 35ab4a9a-42cc-48ec-8299-b8aeaab23053

## Context

Continued recovery from failed prior session on Python rewrite branch. Prior session completed 12/13 restructure tasks. This session picked up remaining work and discovered/fixed multiple edge cases during E2E organize testing.

## What Was Done

### 1. Path Parser Hardening (ops/organize.py)

**Author Heuristics**
- `_looks_like_author()` now rejects:
  - Single-word names ("Mistborn" = series, not author)
  - >5 words (likely sentence fragments)
  - Article-prefixed names ("The Name of the Wind")
- Prevents false author extractions from title/series text

**Pattern G: Bracket Positions**
- Added: `Mistborn [01] The Final Empire` -> series=Mistborn, position=1, title=The Final Empire
- Handles bracket notation for series position inline

**Parenthesized Series Extraction**
- Added: `Title - (Kingkiller Chronicles - Day 1)` -> series=Kingkiller Chronicles, position=1
- Extracts series name and position from parenthetical suffix

**Title Cleanup**
- Strips `(The AudioBook)`, `(Unabridged)` suffixes
- Fixes trailing dash artifacts: `Food- A Love Story` -> `Food A Love Story`
- Normalizes positions: "01" -> "1", "003" -> "3" in `_build_result()`

**Pattern Removed**
- Inline comma series extraction removed (e.g., "Kingkiller Chronicle, Book 2.5")
- Too fragile, caused more harm than good -- AI handles these cases

### 2. AI Response Cleanup (ai.py)

- Added title junk stripping in `_parse_resolve_response()` -- same cleanup as path parser
- Added position normalization in AI response parsing
- Ensures consistent output regardless of AI response format

### 3. Duplicate Folder Detection (ops/organize.py)

**New Functions**
- `_normalize_for_compare()` -- strips years, editions, punctuation, trailing 's' for singular/plural matching
- `_reuse_existing()` -- scans parent dir for near-match folders before creating new ones

**Integration**
- Added to `build_plex_path()` at every directory level (author, series, title)
- Prevents duplicates like "Food A Love Story" vs "Food- A Love Story (2014)" or "Kingkiller Chronicle" vs "Kingkiller Chronicles"

### 4. Widened Audible Search (stages/organize.py)

**When AI Available**
- `_search_audible()` now accepts `author` and `widen` params
- Adds `author+title` and `author+series` query combinations to search
- AI filters wider result set via disambiguation
- Only when `widen=bool(config.pipeline_llm_base_url)` -- no point without AI

### 5. Documentation Updates

- Updated `src/audiobook_pipeline/__init__.py` docstring -- reflects ai module
- Updated `src/audiobook_pipeline/ops/__init__.py` docstring -- reflects dedup logic
- Auto-regenerated README files from docstrings

### 6. Requirements Generation

- Added `scripts/gen-requirements.py` pre-commit hook
- Generates `requirements.txt` from `pyproject.toml` dependencies
- Now tracked and committed

### 7. Live Organize Test

**Results:** 65/65 books organized to `/Volumes/media_files/AudioBooks`
- No duplicate folders created
- All edge cases handled correctly
- No crashes or errors

## Key Decisions

| Decision | Rationale |
|----------|-----------|
| Single-word names rejected | "Mistborn" is a series, not an author -- too ambiguous |
| Inline series pattern removed | Comma pattern too fragile, AI handles better |
| Dedup via normalization | Simpler and more predictable than fuzzy matching |
| Widened search only with AI | No value in wider results without AI filtering |
| Position normalization everywhere | Consistency across parser, AI, and filesystem |

## Known Issues / Warts

1. **SRoST inline series junk** -- AI didn't extract, parser can't reliably parse. Manual cleanup needed or improved prompt.
2. **Subseries vs unified series** -- Mistborn [05] landed under "Wax and Wayne" instead of unified "Mistborn". AI chose subseries name.
3. **Underscores from sanitizer** -- "American Gods_ The Tenth Anniversary Edition" has underscore (colon replacement). Cosmetic only.
4. **Filenames unchanged** -- Still have original source names like `Orson Scott Card-Enderverse-#1-Ender Series-#1-Ender's Game.m4b`. Would need dedicated rename logic.

## Files Changed

| File | Action |
|------|--------|
| `src/audiobook_pipeline/ai.py` | Title cleanup + position normalization in AI response parsing |
| `src/audiobook_pipeline/ops/organize.py` | Pattern G, parenthesized series, author heuristics, dedup, title cleanup, position normalization, widened search support |
| `src/audiobook_pipeline/stages/organize.py` | Widened Audible search with author queries when AI available |
| `src/audiobook_pipeline/__init__.py` | Updated docstring |
| `src/audiobook_pipeline/ops/__init__.py` | Updated docstring |
| `src/audiobook_pipeline/README.md` | Auto-generated from docstrings |
| `src/audiobook_pipeline/ops/README.md` | Auto-generated from docstrings |
| `requirements.txt` | NEW -- auto-generated from pyproject.toml |

## Commits Made

1. `a4e878c` -- fix: improve organize stage metadata resolution and dedup
2. `0364edc` -- docs: update __init__.py docstrings for ai and ops changes
3. `41cac27` -- build: add pyproject.toml, pre-commit hooks, and requirements.txt

## Next Session

**Carry Forward:**
- Python rewrite branch is now feature-complete and E2E tested
- 65/65 live books organized with no errors
- Pre-commit hooks installed and working
- Known cosmetic issues documented above (not blockers)

**Next Steps:**
1. Merge feat/python-rewrite to main via PR
2. Consider improvements for known issues (SRoST junk, subseries vs unified, filename cleanup)
3. Add more test cases for edge patterns discovered during live testing
