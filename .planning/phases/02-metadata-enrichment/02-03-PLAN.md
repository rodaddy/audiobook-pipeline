---
phase: 02-metadata-enrichment
plan: 03
type: execute
wave: 2
depends_on: [02-01, 02-02]
files_modified:
  - stages/06-metadata.sh
  - lib/metadata.sh
  - bin/audiobook-convert
  - lib/manifest.sh
  - config.env.example
autonomous: true

must_haves:
  truths:
    - "M4B file contains title, author, narrator, series, genre, year, and description tags after pipeline run"
    - "Cover art is embedded in the M4B when Audnexus provides an image URL"
    - "Audnexus chapters replace file-boundary chapters when duration matches within 5%"
    - "desc.txt and reader.txt companion files exist alongside the output M4B"
    - "Pipeline completes successfully even when ASIN is missing or Audnexus API is unreachable"
    - "ASIN is stored in a custom M4B field for future re-runs"
  artifacts:
    - path: "stages/06-metadata.sh"
      provides: "Metadata enrichment stage orchestrating ASIN lookup, Audnexus fetch, tone tagging, verification, and companion files"
      contains: "stage_metadata"
    - path: "lib/metadata.sh"
      provides: "tone CLI wrapper functions -- tag_m4b, verify_metadata, download_cover, convert_chapters, generate_companions"
      contains: "tag_m4b"
    - path: "bin/audiobook-convert"
      provides: "Updated pipeline with stage 06 in STAGE_MAP and STAGE_ORDER"
      contains: "metadata"
    - path: "lib/manifest.sh"
      provides: "Updated manifest_create with metadata stage entry"
      contains: "metadata"
    - path: "config.env.example"
      provides: "METADATA_SKIP, FORCE_METADATA config vars"
      contains: "METADATA_SKIP"
  key_links:
    - from: "stages/06-metadata.sh"
      to: "lib/metadata.sh"
      via: "source and function calls"
      pattern: "source.*lib/metadata\\.sh"
    - from: "stages/06-metadata.sh"
      to: "lib/manifest.sh"
      via: "manifest_set_stage and manifest_update"
      pattern: "manifest_set_stage.*metadata"
    - from: "bin/audiobook-convert"
      to: "stages/06-metadata.sh"
      via: "STAGE_MAP and STAGE_ORDER arrays"
      pattern: "\\[metadata\\]"
    - from: "stages/06-metadata.sh"
      to: "tone"
      via: "tag_m4b calling tone tag CLI"
      pattern: "tone tag"
---

<objective>
Write metadata tags, embed cover art, import Audnexus chapters, and generate companion files for M4B audiobooks using tone CLI.

Purpose: This is the final step of Phase 2 metadata enrichment -- it takes the ASIN (from 02-01) and fetched metadata/chapters (from 02-02) and applies them to the M4B file. Without this, the M4B has no tags, no cover, and only file-boundary chapters.

Output: `stages/06-metadata.sh` (new stage), `lib/metadata.sh` (tone wrapper library), updated pipeline entry point and manifest schema.
</objective>

<execution_context>
@/Users/rico/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rico/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-metadata-enrichment/02-RESEARCH.md
@stages/03-convert.sh
@stages/04-cleanup.sh
@lib/core.sh
@lib/manifest.sh
@bin/audiobook-convert
@config.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create lib/metadata.sh and stages/06-metadata.sh</name>
  <files>lib/metadata.sh, stages/06-metadata.sh</files>
  <action>
**lib/metadata.sh** -- tone CLI wrapper library (~200 lines). Source `lib/core.sh` for logging. Functions:

1. `download_cover_art BOOK_JSON OUTPUT_PATH` -- Extract `.image` from book JSON via jq, upgrade URL resolution with `sed 's/_SL[0-9]*_/_SL2000_/'`, download with `curl -fsSL --max-time 30`, fallback to original resolution on failure, validate JPEG magic bytes (`xxd -l 3 -p | grep -q '^ffd8ff'`). Return 1 on failure (non-fatal).

2. `convert_chapters_to_tone CHAPTERS_JSON OUTPUT_PATH` -- Takes Audnexus chapters JSON (from 02-02's cached file), uses jq to convert `startOffsetMs` to `HH:MM:SS.mmm Title` format for tone's `--meta-chapters-file`. Use this jq pipeline:
   ```
   jq -r '.chapters[] | ... format as HH:MM:SS.mmm title'
   ```
   See research Pattern 7 for exact jq expression. Write output to `$OUTPUT_PATH/chapters.txt`.

3. `validate_chapter_duration M4B_FILE AUDNEXUS_RUNTIME_MS` -- Get M4B duration via `get_duration` (from lib/ffmpeg.sh), convert Audnexus milliseconds to seconds, calculate percentage difference, return 1 if >5%. Use `bc` for floating point math. See research Pattern 3.

4. `tag_m4b M4B_FILE WORK_DIR BOOK_JSON [CHAPTERS_FILE]` -- Build tone tag argument array conditionally:
   - Extract fields from BOOK_JSON via jq: title, author (`.authors | map(.name) | join(", ")`), narrator (`.narrators | join(", ")`), genre (`.genres[0].name // empty`), description, series name/position
   - `--meta-recording-date`: Extract from `.releaseDate` if present, otherwise derive `YYYY-01-01` from `.copyright`. MUST be ISO 8601 `YYYY-MM-DD` format -- never pass bare year string
   - `--meta-cover-file "$WORK_DIR/cover.jpg"` only if file exists
   - `--meta-chapters-file "$CHAPTERS_FILE"` only if file provided and exists
   - `--meta-additional-field "----:com.pilabor.tone:AUDIBLE_ASIN=$ASIN"` to store ASIN in M4B for future re-runs
   - Call `tone tag "$M4B_FILE" "${tone_args[@]}"` -- single invocation, never tag on NFS
   - Return exit code from tone

5. `verify_metadata M4B_FILE EXPECTED_TITLE` -- Run `tone dump "$M4B_FILE" --format json --include-property title --include-property artist --include-property narrator --include-property chapters` (MUST use `--include-property` to avoid binary data from embedded pictures breaking JSON). Parse with jq, verify title matches expected, log chapter count. Return 1 on mismatch.

6. `generate_companions WORK_DIR BOOK_JSON NARRATOR` -- Write `desc.txt` (description with HTML tags stripped via `sed 's/<[^>]*>//g'`) and `reader.txt` (narrator name) to WORK_DIR. UTF-8 without BOM.

**stages/06-metadata.sh** -- Follow the exact same structure as `stages/03-convert.sh`:
- Shebang: `#!/usr/bin/env bash`
- `set -euo pipefail`
- `SCRIPT_DIR` and `STAGE="metadata"`
- Source: `lib/core.sh`, `lib/ffmpeg.sh`, `lib/manifest.sh`, `lib/metadata.sh`
- Main function: `stage_metadata()`
- Guard: `if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then stage_metadata; fi`

`stage_metadata()` orchestrates:
1. Check required env vars: `WORK_DIR`, `SOURCE_PATH`, `BOOK_HASH`
2. Check `METADATA_SKIP` config var -- if `true`, log_info "Metadata enrichment disabled" and return 0 immediately
3. Locate M4B from manifest: `manifest_read "$BOOK_HASH" "stages.convert.output_file"` -- die if not found
4. Read ASIN from manifest: `manifest_read "$BOOK_HASH" "metadata.asin"` (set by 02-01 stage). If empty, `log_warn "No ASIN found -- skipping metadata enrichment"` and set stage completed with `enriched: false`, return 0
5. Read cached book JSON: `$WORK_DIR/audnexus_book_${ASIN}.json` (written by 02-02). If missing, log_warn and return 0
6. Download cover art: `download_cover_art "$book_json_content" "$WORK_DIR/cover.jpg"` -- log warning on failure, continue
7. Read cached chapters JSON: `$WORK_DIR/audnexus_chapters_${ASIN}.json` (written by 02-02). If exists, validate duration match via `validate_chapter_duration`, then convert via `convert_chapters_to_tone`. On duration mismatch, log_warn and skip Audnexus chapters (file-boundary chapters from Phase 1 remain)
8. Tag M4B: `tag_m4b "$m4b_file" "$WORK_DIR" "$book_json_content" "$chapters_file"` -- this is the only step where failure is potentially fatal. If tone exits non-zero, log_error and return 1
9. Verify metadata: `verify_metadata "$m4b_file" "$expected_title"` -- log warning on mismatch but don't fail
10. Generate companion files: `generate_companions "$WORK_DIR" "$book_json_content" "$narrator"`
11. Update manifest: `manifest_set_stage "$BOOK_HASH" "metadata" "completed"` plus metadata details (asin, title, chapter_count, enriched: true)

**Graceful degradation is critical.** Only `tone tag` failure should cause stage failure (return 1). All other failures (no ASIN, no API data, no cover, no chapters, duration mismatch) should log warnings and continue. The stage should exit 0 even without any metadata -- the M4B is still valid from Phase 1.
  </action>
  <verify>
- `bash -n stages/06-metadata.sh` exits 0 (syntax valid)
- `bash -n lib/metadata.sh` exits 0 (syntax valid)
- `shellcheck stages/06-metadata.sh` passes (no errors, warnings acceptable)
- `shellcheck lib/metadata.sh` passes
- `grep -c 'tone tag' lib/metadata.sh` returns at least 1
- `grep -c 'log_warn' stages/06-metadata.sh` returns at least 3 (graceful degradation paths)
- `grep 'meta-recording-date' lib/metadata.sh` confirms ISO 8601 formatting logic
- `grep 'include-property' lib/metadata.sh` confirms safe JSON dump (no binary data)
  </verify>
  <done>
- stages/06-metadata.sh exists with stage_metadata() following the same pattern as stages/03-convert.sh
- lib/metadata.sh exists with tag_m4b, verify_metadata, download_cover_art, convert_chapters_to_tone, validate_chapter_duration, generate_companions
- Both pass bash -n and shellcheck
- Graceful degradation: stage returns 0 when ASIN missing, API data missing, cover download fails, or chapter duration mismatches
- Only tone tag failure causes stage failure (return 1)
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire stage 06 into pipeline and update manifest schema</name>
  <files>bin/audiobook-convert, lib/manifest.sh, config.env.example</files>
  <action>
**bin/audiobook-convert:**
1. Add `lib/metadata.sh` to the source block (after `lib/sanitize.sh`):
   ```bash
   source "$LIB_DIR/metadata.sh"
   ```
2. Add `metadata` to the STAGE_MAP associative array:
   ```bash
   [metadata]="06"
   ```
3. Update STAGE_ORDER array to: `(validate concat convert asin metadata cleanup)`
   This ensures: asin runs BEFORE metadata (metadata needs the ASIN), metadata runs AFTER convert (needs M4B), and cleanup remains the finisher.

**lib/manifest.sh:**
1. In `manifest_create()`, add `metadata` stage to the initial JSON template:
   ```json
   "metadata": { "status": "pending" }
   ```
   Place it after `asin` and before `cleanup` in the stages object.
2. In `get_next_stage()`, add `metadata` to the for loop's stage list:
   ```bash
   for stage in validate concat convert asin metadata cleanup; do
   ```

**config.env.example:**
Add metadata configuration section after the "Behavior" section:
```bash
# Metadata enrichment (Phase 2)
METADATA_SKIP=false          # Set true to skip metadata enrichment entirely
FORCE_METADATA=false         # Set true to re-fetch metadata even if cached
```

Do NOT add `--skip-metadata` CLI flag yet -- the config var is sufficient for now. CLI flags can be added in Phase 4 when the full automation interface is designed.
  </action>
  <verify>
- `grep 'metadata' bin/audiobook-convert` shows STAGE_MAP entry and STAGE_ORDER inclusion
- `grep -c 'metadata' lib/manifest.sh` returns at least 2 (manifest_create + get_next_stage)
- `grep 'METADATA_SKIP' config.env.example` confirms config var present
- `bash -n bin/audiobook-convert` exits 0
- `bash -n lib/manifest.sh` exits 0
- Stage order in STAGE_ORDER array is: validate, concat, convert, asin, metadata, cleanup
  </verify>
  <done>
- bin/audiobook-convert sources lib/metadata.sh, includes metadata in STAGE_MAP as "06", and STAGE_ORDER is (validate concat convert asin metadata cleanup)
- lib/manifest.sh creates manifests with metadata stage entry and get_next_stage iterates through metadata
- config.env.example has METADATA_SKIP and FORCE_METADATA vars documented
- All modified files pass bash -n syntax check
  </done>
</task>

</tasks>

<verification>
1. `bash -n stages/06-metadata.sh && bash -n lib/metadata.sh && bash -n bin/audiobook-convert && bash -n lib/manifest.sh` -- all pass syntax check
2. `shellcheck stages/06-metadata.sh lib/metadata.sh` -- no errors
3. `grep -A1 'STAGE_ORDER' bin/audiobook-convert` -- shows (validate concat convert asin metadata cleanup)
4. `grep 'metadata.*pending' lib/manifest.sh` -- confirms manifest schema includes metadata stage
5. `grep 'tone tag' lib/metadata.sh` -- confirms tone CLI integration
6. `grep 'METADATA_SKIP\|FORCE_METADATA' config.env.example` -- config vars documented
7. Dry-run test: `./bin/audiobook-convert --dry-run /path/to/test-book/` -- pipeline runs through all 6 stages without error (metadata stage skips gracefully due to no ASIN in dry-run)
</verification>

<success_criteria>
- New stage 06 (metadata) exists and integrates into the 6-stage pipeline: validate -> concat -> convert -> asin -> metadata -> cleanup
- Pipeline execution order is correct: asin (05) runs BEFORE metadata (06) so metadata has the ASIN available
- tone CLI wrapper library handles all tagging operations with proper error handling
- Graceful degradation: metadata failures never block the pipeline
- Companion files (desc.txt, reader.txt) generated alongside M4B
- Cover art downloaded at high resolution and embedded
- Audnexus chapters replace file-boundary chapters when duration validates within 5%
- ASIN stored in M4B custom field for future pipeline re-runs
- All files pass shellcheck and bash -n
</success_criteria>

<output>
After completion, create `.planning/phases/02-metadata-enrichment/02-03-SUMMARY.md`
</output>
